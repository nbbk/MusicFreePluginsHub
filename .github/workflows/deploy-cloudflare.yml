name: Daily Sync and Deploy to Cloudflare Pages

on:
  schedule:
    - cron: "0 17 * * *"  # 每天 UTC 17:00 运行 (北京时间 1:00)
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Sync with upstream repository (optional, only if you're working with a fork)
      - name: Sync with upstream repository
        run: |
          git remote add upstream https://github.com/UPSTREAM_OWNER/UPSTREAM_REPO.git
          git fetch upstream
          git checkout main
          git merge upstream/main

      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Install project dependencies from pyproject.toml
      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt  # 如果有生成 requirements.txt
          # 如果没有 requirements.txt，可以通过 `pyproject.toml` 安装依赖
          pip install .

      # Run any necessary Python script or command (e.g., a build script or main.py)
      - name: Run Python Script (if necessary)
        run: |
          python src/main.py

      # Deploy to Cloudflare Pages (optional, depending on project setup)
      - name: Deploy to Cloudflare Pages
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}  # 使用你的 Cloudflare API Token
        run: |
          curl -X POST https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/${{ secrets.CF_PROJECT_NAME }}/deployments \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -F "branch=main" \
            -F "metadata[deploy_env]=production"
